--- 1 ---

Files
=====

## /NOTES.md (size: 627 bytes)

```javascript
    
    Files
    =====
    
    ## /NOTES.md (size: %%%size['/.NOTES.md']%%% bytes)
    
    ```javascript
        %%%code['/.NOTES.md']%%%
    ```
    
    ## /main.sh (size: %%%size['/main.sh']%%% bytes)
    
    ```javascript
    %%%code['/main.sh']%%%
    ```
    
    ## /inf.json (size: %%%size['/inf.json']%%% bytes)
    
    ```javascript
    %%%code['/inf.json']%%%
    ```
    
    ## /bundle.inf.js (size: %%%size['/bundle.inf.js']%%% bytes)
    
    ```javascript
    %%%code['/bundle.inf.js']%%%
    ```
    
    ## /.~inf.json~infi.log (size: %%%size['/.~inf.json~infi.log']%%% bytes)
    
    ```javascript
    %%%code['/.~inf.json~infi.log']%%%
    ```
    
    ## /ui.js (size: %%%size['/.ui.js']%%% bytes)
    
    ```javascript
    %%%code['/.ui.js']%%%
    ```
    
```

## /main.sh (size: 634 bytes)

```javascript
#!/usr/bin/env bash.origin.script

inf inf.json

echo '--- 1 ---'

cat .NOTES.md

echo '--- 2 ---'

echo ">>>TEST_IGNORE_LINE:\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}<<<"

cat .ui.js
cp -f .ui.js .ui.js~before
perl -i -pe 's/Count: 1/Count: 2/g' .ui.js

echo '--- 3 ---'

cat .ui.js

cp -f bundle.inf.js bundle.inf.js~before
inf {
    "bundle #": "./bundle.",
    "bundle # do": "contract"
}

echo '--- 4 ---'

diff -u .ui.js .ui.js~before || true

echo '--- 5 ---'

diff -u bundle.inf.js bundle.inf.js~before || true

echo '--- 6 ---'

rm -f .ui.js
mv -f .ui.js~before .ui.js

rm -f bundle.inf.js
mv -f bundle.inf.js~before bundle.inf.js

```

## /inf.json (size: 80 bytes)

```javascript
#!/usr/bin/env inf
{
    "bundle #": "./bundle.",

    "bundle # do": "expand"
}
```

## /bundle.inf.js (size: 5479 bytes)

```javascript

'use strict';

exports.inf = async function (inf) {

    return {

        invoke: async function (pointer, value) {

            if (pointer === "do") {
                if (value.value === "expand") {

                    function varPlaceholder (key) {
                        const val = new String(`%%%${key}%%%`);
                        val.replaceVariables = false;
                        return val;
                    }

                    return inf.expandNodeAspectsTo(/^\//, __dirname, function (aspect, key) {

                        if (aspect === '/.NOTES.md') {
                            var keyParts = key.match(/^([^\[]+)\['([^']+)'\]$/);

                            if (keyParts[1] === 'size') {
                                if (
                                    keyParts[2] === '/.NOTES.md' ||
                                    keyParts[2] === '/.ui.js'
                                ) {
                                    return inf.getNodeAspect(keyParts[2], varPlaceholder).length;
                                }
                                if (!inf.LIB.FS.existsSync(inf.LIB.PATH.join(__dirname, keyParts[2]))) {
                                    return '0';
                                }
                                return inf.LIB.FS.statSync(inf.LIB.PATH.join(__dirname, keyParts[2])).size;
                            } else
                            if (keyParts[1] === 'code') {
                                if (
                                    keyParts[2] === '/.NOTES.md' ||
                                    keyParts[2] === '/.ui.js'
                                ) {
                                    let code = inf.getNodeAspect(keyParts[2], varPlaceholder);
                                    code = new String(code);
                                    code.replaceVariables = false;
                                    return code;
                                }
                                if (!inf.LIB.FS.existsSync(inf.LIB.PATH.join(__dirname, keyParts[2]))) {
                                    return '';
                                }
                                let code = inf.LIB.FS.readFileSync(inf.LIB.PATH.join(__dirname, keyParts[2]), 'utf8');
                                if (keyParts[2] === '/bundle.inf.js') {
                                    code = new String(code);
                                    code.replaceVariables = false;
                                }
                                return code;
                            }

                            throw new Error(`No value for key '${key}' in aspet '${aspect}'!`);
                        }
                    });
                } else
                if (value.value === "contract") {

                    let code = await inf.LIB.FS.readFileAsync(inf.LIB.PATH.join(__dirname, '/.ui.js'), 'utf8');
                    let bundlePath = inf.LIB.PATH.join(__dirname, '/bundle.inf.js');
                    let bundle = await inf.LIB.FS.readFileAsync(bundlePath, 'utf8');

                    // TODO: Fix codeblock parsing so we can use codeblock syntax in regexp without interference.
                    let indentRe = new RegExp('^([\\s\\t]*)"\\/\\.ui\\.js": \\(javascript \\(\\) >' + '>>', 'm');
                    let indent = bundle.match(indentRe)[1];
                    if (/\s$/.test(indent)) {
                        indent += '    ';   // 4 spaces soft tab
                    } else
                    if (/\s$/.test(indent)) {
                        indent += ' ';      // 1 hard tab
                    }
                    code = code.split("\n").map(function (line, i) {
                        return indent + line;
                    });
                    code = code.slice(1, code.length - 2).join("\n").replace(/(^\n|\n$)/g, "");

                    // TODO: Fix codeblock parsing so we can use codeblock syntax in regexp without interference.
                    let bundleRe = new RegExp('("\\/\\.ui\\.js": \\(javascript \\(\\) >' + '>>\\s*\\n)[\\s\\S]+?(\\s*<<' + '<\\),)');
                    bundle = bundle.replace(bundleRe, "$1" + code + "$2");

                    await inf.LIB.FS.writeFileAsync(bundlePath, bundle, 'utf8');

                    return;
                }
            }

            throw new Error("NYI");
        },

        "/.ui.js": (javascript () >>>

            console.log("Count: 1");

        <<<),

        "/.NOTES.md": (markdown (code, size) >>>

            Files
            =====

            ## /NOTES.md (size: %%%size['/.NOTES.md']%%% bytes)

            ```javascript
                %%%code['/.NOTES.md']%%%
            ```

            ## /main.sh (size: %%%size['/main.sh']%%% bytes)

            ```javascript
            %%%code['/main.sh']%%%
            ```

            ## /inf.json (size: %%%size['/inf.json']%%% bytes)

            ```javascript
            %%%code['/inf.json']%%%
            ```

            ## /bundle.inf.js (size: %%%size['/bundle.inf.js']%%% bytes)

            ```javascript
            %%%code['/bundle.inf.js']%%%
            ```

            ## /.~inf.json~infi.log (size: %%%size['/.~inf.json~infi.log']%%% bytes)

            ```javascript
            %%%code['/.~inf.json~infi.log']%%%
            ```

            ## /ui.js (size: %%%size['/.ui.js']%%% bytes)

            ```javascript
            %%%code['/.ui.js']%%%
            ```

        <<<)
    };
}

```

## /.~inf.json~infi.log (size: 41 bytes)

```javascript
bundle #	"./bundle."
bundle # do	"expand"
```

## /ui.js (size: 26 bytes)

```javascript

console.log("Count: 1");

```

--- 2 ---
>>>TEST_IGNORE_LINE:\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}<<<

console.log("Count: 1");

--- 3 ---

console.log("Count: 2");

--- 4 ---
@@ -1,3 +1,3 @@
 
-console.log("Count: 2");
+console.log("Count: 1");
 
--- 5 ---
@@ -7,7 +7,7 @@
 
         "/.ui.js": (javascript () >>>
 
-            console.log("Count: 2");
+            console.log("Count: 1");
 
         <<<),
 
--- 6 ---
